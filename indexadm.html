<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberSync - Painel Administrativo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        /*  Adicionadas variáveis CSS para tema claro e escuro */
        :root {
            --dark-bg: #0a0a0a; 
            --dark-card: #1a1a1a; 
            --lime: #87ceeb; 
            --lime-dark: #4682b4;
            --text: #ffffff; 
            --text-muted: #888888; 
            --red: #ff4444; 
            --orange: #ff9800; 
            --green: #4caf50;
            --whatsapp: #25D366;
            --confirm: #1e90ff; 
            --border-radius: 8px;
            --transition: all 0.3s ease;
            --shadow: 0 3px 20px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 5px 30px rgba(135, 206, 235, 0.2);
        }

        /* Tema Claro */
        [data-theme="light"] {
            --dark-bg: #f5f5f5;
            --dark-card: #ffffff;
            --text: #1a1a1a;
            --text-muted: #666666;
            --shadow: 0 3px 20px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 5px 30px rgba(135, 206, 235, 0.3);
        }
        /* </CHANGE> */
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--dark-bg); 
            color: var(--text); 
            line-height: 1.6; 
            transition: var(--transition);
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        header { 
            background: linear-gradient(135deg, var(--lime) 0%, var(--lime-dark) 100%); 
            padding: 30px 20px; 
            text-align: center; 
            box-shadow: var(--shadow); 
            margin-bottom: 30px; 
            position: relative;
        }
        
        header h1 { 
            font-size: 36px; 
            color: #fff; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        
        /*  Botão de alternância de tema */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        /* </CHANGE> */
        
        .logout-btn { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            background: rgba(255, 255, 255, 0.2); 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            color: white; 
            padding: 10px 20px; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-size: 16px; 
            transition: var(--transition); 
        }
        
        .logout-btn:hover { 
            background: rgba(255, 255, 255, 0.3); 
            transform: translateY(-2px); 
        }
        
        .card { 
            background: var(--dark-card); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: var(--shadow); 
            margin-bottom: 25px; 
            transition: var(--transition); 
        }
        
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--shadow-hover); 
        }
        
        .card h2 { 
            color: var(--lime); 
            margin-bottom: 20px; 
            font-size: 24px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: var(--text-muted); 
            font-weight: 500; 
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #333; 
            background: var(--dark-bg); 
            color: var(--text); 
            border-radius: var(--border-radius); 
            font-size: 16px; 
            transition: var(--transition); 
        }

        [data-theme="light"] .form-group input,
        [data-theme="light"] .form-group select,
        [data-theme="light"] .form-group textarea {
            border: 2px solid #ddd;
        }
        
        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus { 
            outline: none; 
            border-color: var(--lime); 
            box-shadow: 0 0 0 3px rgba(135, 206, 235, 0.1); 
        }
        
        .btn { 
            background: var(--lime); 
            color: var(--dark-bg); 
            padding: 12px 30px; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold; 
            transition: var(--transition); 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .btn:hover { 
            background: var(--lime-dark); 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(135, 206, 235, 0.4); 
        }
        
        .btn-secondary { 
            background: #333; 
            color: var(--text); 
        }

        [data-theme="light"] .btn-secondary {
            background: #e0e0e0;
        }
        
        .btn-secondary:hover { 
            background: #444; 
        }

        [data-theme="light"] .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .content-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 25px; 
        }
        
        .full-width { 
            grid-column: 1 / -1; 
        }
        
        .services-list, 
        .barbers-list { 
            display: grid; 
            gap: 15px; 
            margin-top: 20px; 
        }
        
        .service-item, 
        .barber-item { 
            background: var(--dark-bg); 
            padding: 15px; 
            border-radius: var(--border-radius); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: var(--transition); 
            border-left: 4px solid var(--lime); 
        }
        
        .service-item:hover, 
        .barber-item:hover { 
            transform: translateX(5px); 
            box-shadow: 0 3px 15px rgba(135, 206, 235, 0.2); 
        }
        
        .item-info h4 { 
            color: var(--lime); 
            margin-bottom: 5px; 
        }
        
        .item-info p { 
            color: var(--text-muted); 
            font-size: 14px; 
        }
        
        .item-actions { 
            display: flex; 
            gap: 10px; 
        }
        
        .btn-edit, 
        .btn-delete, 
        .btn-cancel, 
        .btn-complete, 
        .btn-whatsapp { 
            padding: 8px 15px; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-size: 14px; 
            transition: var(--transition); 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
        }
        
        .btn-edit { 
            background: var(--orange); 
            color: white; 
        }
        
        .btn-delete { 
            background: var(--red); 
            color: white; 
        }
        
        .btn-cancel { 
            background: var(--red); 
            color: white; 
        }
        
        .btn-complete { 
            background: var(--green); 
            color: white; 
        }
        
        .btn-whatsapp { 
            background: var(--whatsapp); 
            color: white; 
        }
        
        .btn-edit:hover, 
        .btn-delete:hover, 
        .btn-cancel:hover, 
        .btn-complete:hover, 
        .btn-whatsapp:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 3px 10px rgba(0,0,0,0.3); 
        }
        
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 15px 25px; 
            border-radius: var(--border-radius); 
            color: white; 
            font-weight: bold; 
            z-index: 1000; 
            animation: slideIn 0.3s ease; 
            box-shadow: var(--shadow); 
        }
        
        @keyframes slideIn { 
            from { 
                transform: translateX(400px); 
                opacity: 0; 
            } 
            to { 
                transform: translateX(0); 
                opacity: 1; 
            } 
        }
        
        .notification.success { 
            background: var(--green); 
        }
        
        .notification.error { 
            background: var(--red); 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 40px; 
            color: var(--text-muted); 
        }
        
        .empty-state i { 
            font-size: 48px; 
            margin-bottom: 15px; 
            opacity: 0.5; 
        }
        
        .filter-section { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        
        .filter-section select, 
        .filter-section input { 
            flex: 1; 
            min-width: 200px; 
        }
        
        /*  Estilos para visualização em calendário */
        .calendar-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-header {
            text-align: center;
            padding: 10px;
            background: var(--lime);
            color: var(--dark-bg);
            font-weight: bold;
            border-radius: var(--border-radius);
        }

        .calendar-day {
            background: var(--dark-card);
            border: 2px solid #333;
            border-radius: var(--border-radius);
            padding: 10px;
            min-height: 120px;
            transition: var(--transition);
            position: relative;
        }

        [data-theme="light"] .calendar-day {
            border: 2px solid #ddd;
        }

        .calendar-day:hover {
            border-color: var(--lime);
            transform: translateY(-2px);
        }

        .calendar-day.today {
            border-color: var(--lime);
            background: rgba(135, 206, 235, 0.1);
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day-number {
            font-weight: bold;
            color: var(--lime);
            margin-bottom: 5px;
        }

        .calendar-appointment {
            background: var(--lime);
            color: var(--dark-bg);
            padding: 5px;
            margin: 3px 0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-appointment:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(135, 206, 235, 0.4);
        }

        .calendar-appointment.completed {
            background: var(--green);
            color: white;
        }

        .calendar-appointment.cancelled {
            background: var(--red);
            color: white;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--dark-card);
            border-radius: var(--border-radius);
        }

        .calendar-controls button {
            background: var(--lime);
            color: var(--dark-bg);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
        }

        .calendar-controls button:hover {
            background: var(--lime-dark);
        }

        .calendar-month-year {
            font-size: 20px;
            font-weight: bold;
            color: var(--lime);
        }
        /* </CHANGE> */
        
        .booking-item { 
            background: var(--dark-bg); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 15px; 
            border-left: 4px solid var(--lime); 
            transition: var(--transition); 
        }
        
        .booking-item:hover { 
            transform: translateX(5px); 
            box-shadow: 0 3px 15px rgba(135, 206, 235, 0.2); 
        }
        
        .booking-main { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 15px; 
        }
        
        .booking-client h4 { 
            color: var(--lime); 
            margin-bottom: 8px; 
            font-size: 18px; 
        }
        
        .booking-client p { 
            color: var(--text-muted); 
            font-size: 14px; 
            margin: 4px 0; 
        }
        
        .booking-status { 
            padding: 8px 15px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold; 
            text-transform: uppercase; 
        }
        
        .status-confirmed { 
            background: rgba(30, 144, 255, 0.2); 
            color: var(--confirm); 
            border: 2px solid var(--confirm); 
        }
        
        .status-completed { 
            background: rgba(76, 175, 80, 0.2); 
            color: var(--green); 
            border: 2px solid var(--green); 
        }
        
        .status-cancelled { 
            background: rgba(255, 68, 68, 0.2); 
            color: var(--red); 
            border: 2px solid var(--red); 
        }
        
        .booking-datetime-highlight { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 15px; 
            background: rgba(135, 206, 235, 0.1); 
            border-radius: var(--border-radius); 
            margin-bottom: 15px; 
        }
        
        .datetime-box { 
            text-align: center; 
        }
        
        .datetime-label { 
            font-size: 12px; 
            color: var(--text-muted); 
            text-transform: uppercase; 
        }
        
        .datetime-value { 
            font-size: 20px; 
            font-weight: bold; 
            color: var(--lime); 
        }
        
        .datetime-separator { 
            font-size: 24px; 
            color: var(--lime); 
        }
        
        .booking-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .booking-actions { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        
        .dashboard-toggle-container { 
            max-width: 1400px; 
            margin: 0 auto 30px; 
            padding: 0 20px; 
        }
        
        .dashboard-toggle-btn { 
            width: 100%; 
            background: var(--dark-card); 
            color: var(--lime); 
            border: 2px solid var(--lime); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-size: 20px; 
            font-weight: bold; 
            transition: var(--transition); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: var(--shadow); 
        }
        
        .dashboard-toggle-btn:hover { 
            background: rgba(135, 206, 235, 0.1); 
            transform: translateY(-3px); 
            box-shadow: 0 5px 30px rgba(135, 206, 235, 0.4); 
        }
        
        .dashboard-toggle-btn i { 
            font-size: 24px; 
            transition: transform 0.3s; 
        }
        
        .dashboard-toggle-btn.active i { 
            transform: rotate(180deg); 
        }
        
        .dashboard-container { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out; 
            opacity: 0; 
        }
        
        .dashboard-container.active { 
            max-height: 10000px; 
            opacity: 1; 
        }
        
        .period-selector { 
            display: flex; 
            gap: 10px; 
            margin: 30px 0 20px; 
            flex-wrap: wrap; 
            max-width: 1400px; 
            margin-left: auto; 
            margin-right: auto; 
            padding: 0 20px; 
        }
        
        .period-btn { 
            padding: 10px 20px; 
            background: var(--dark-bg); 
            border: 2px solid #333; 
            color: var(--text); 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-size: 14px; 
            transition: var(--transition); 
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        [data-theme="light"] .period-btn {
            border: 2px solid #ddd;
        }
        
        .period-btn.active { 
            background: var(--lime); 
            color: var(--dark-bg); 
            border-color: var(--lime); 
        }
        
        .period-btn:hover { 
            border-color: var(--lime); 
            transform: translateY(-1px);
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: var(--dark-card); 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: var(--shadow); 
            border-left: 4px solid var(--lime); 
            cursor: pointer; 
            transition: var(--transition); 
            position: relative; 
        }
        
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--shadow-hover); 
        }
        
        .stat-card.expanded { 
            border: 2px solid var(--lime); 
            border-left: 4px solid var(--lime); 
        }
        
        .stat-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .stat-card h3 { 
            color: var(--text-muted); 
            font-size: 14px; 
            margin-bottom: 10px; 
            font-weight: 500;
        }
        
        .stat-card .stat-value { 
            font-size: 32px; 
            font-weight: bold; 
            color: var(--lime); 
            margin: 10px 0; 
        }
        
        .stat-card .stat-icon { 
            font-size: 40px; 
            color: var(--lime); 
            opacity: 0.3; 
        }
        
        .expand-icon { 
            font-size: 20px; 
            color: var(--lime); 
            transition: transform 0.3s; 
        }
        
        .stat-card.expanded .expand-icon { 
            transform: rotate(180deg); 
        }
        
        .stat-details { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease; 
        }
        
        .stat-card.expanded .stat-details { 
            max-height: 500px; 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 2px solid #333; 
        }

        [data-theme="light"] .stat-card.expanded .stat-details {
            border-top: 2px solid #ddd;
        }
        
        .detail-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px; 
            background: var(--dark-bg); 
            margin-bottom: 8px; 
            border-radius: var(--border-radius); 
        }
        
        .charts-section { 
            margin-top: 30px; 
        }
        
        .charts-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 25px; 
        }
        
        .chart-container { 
            background: var(--dark-card); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: var(--shadow); 
        }
        
        .chart-container h3 { 
            color: var(--lime); 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .chart-canvas { 
            position: relative; 
            height: 300px; 
        }
        
        @media (max-width: 768px) { 
            .content-grid { 
                grid-template-columns: 1fr; 
            } 
            
            .charts-grid { 
                grid-template-columns: 1fr; 
            }

            .calendar-container {
                grid-template-columns: repeat(7, 1fr);
                gap: 5px;
            }

            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }

            .calendar-appointment {
                font-size: 10px;
                padding: 3px;
            }
        }
    </style>
</head>
<body>
    <header>
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Sair
        </button>
        <!--  Botão de alternância de tema -->
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Alternar tema">
            <i class="fas fa-sun" id="themeIcon"></i>
        </button>
        <!-- </CHANGE> -->
        <h1><i class="fas fa-cut"></i> BarberSync Admin</h1>
    </header>

    <div class="container">
        <div class="dashboard-toggle-container">
            <button class="dashboard-toggle-btn" onclick="toggleDashboard()" aria-label="Expandir/Recolher Dashboard">
                <span><i class="fas fa-chart-line" aria-hidden="true"></i> Dashboard e Relatórios</span>
                <i class="fas fa-chevron-down" aria-hidden="true"></i>
            </button>
        </div>

        <div class="dashboard-container" id="dashboardContainer">
            <div class="period-selector" role="tablist" aria-label="Seletor de período">
                <button class="period-btn active" onclick="changePeriod('today')" role="tab" aria-selected="true">
                    <i class="fas fa-calendar-day" aria-hidden="true"></i> Hoje
                </button>
                <button class="period-btn" onclick="changePeriod('week')" role="tab" aria-selected="false">
                    <i class="fas fa-calendar-week" aria-hidden="true"></i> Esta Semana
                </button>
                <button class="period-btn" onclick="changePeriod('month')" role="tab" aria-selected="false">
                    <i class="fas fa-calendar" aria-hidden="true"></i> Este Mês
                </button>
                <button class="period-btn" onclick="changePeriod('custom')" role="tab" aria-selected="false">
                    <i class="fas fa-calendar-alt" aria-hidden="true"></i> Período Personalizado
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card" onclick="toggleStatCard(this)" role="button" tabindex="0" aria-expanded="false">
                    <div class="stat-header">
                        <div>
                            <h3>Agendamentos do Período</h3>
                            <div class="stat-value" id="periodBookings">0</div>
                        </div>
                        <div>
                            <i class="fas fa-calendar-check stat-icon" aria-hidden="true"></i>
                            <i class="fas fa-chevron-down expand-icon" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="stat-details" id="bookingsDetails"></div>
                </div>
                
                <div class="stat-card" onclick="toggleStatCard(this)" role="button" tabindex="0" aria-expanded="false">
                    <div class="stat-header">
                        <div>
                            <h3>Faturamento (Apenas Concluídos)</h3>
                            <div class="stat-value" id="periodRevenue">R$ 0</div>
                        </div>
                        <div>
                            <i class="fas fa-dollar-sign stat-icon" aria-hidden="true"></i>
                            <i class="fas fa-chevron-down expand-icon" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="stat-details" id="revenueDetails"></div>
                </div>
                
                <div class="stat-card" onclick="toggleStatCard(this)" role="button" tabindex="0" aria-expanded="false">
                    <div class="stat-header">
                        <div>
                            <h3>Clientes Atendidos</h3>
                            <div class="stat-value" id="periodClients">0</div>
                        </div>
                        <div>
                            <i class="fas fa-users stat-icon" aria-hidden="true"></i>
                            <i class="fas fa-chevron-down expand-icon" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="stat-details" id="clientsDetails"></div>
                </div>
                
                <div class="stat-card" onclick="toggleStatCard(this)" role="button" tabindex="0" aria-expanded="false">
                    <div class="stat-header">
                        <div>
                            <h3>Serviços Mais Populares</h3>
                            <div class="stat-value" id="topService">-</div>
                        </div>
                        <div>
                            <i class="fas fa-cut stat-icon" aria-hidden="true"></i>
                            <i class="fas fa-chevron-down expand-icon" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="stat-details" id="servicesDetails"></div>
                </div>
            </div>

            <div class="charts-section">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3><i class="fas fa-calendar-week" aria-hidden="true"></i> Dias Mais Agendados</h3>
                        <div class="chart-canvas">
                            <canvas id="daysChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-clock" aria-hidden="true"></i> Horários Mais Procurados</h3>
                        <div class="chart-canvas">
                            <canvas id="hoursChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-cut" aria-hidden="true"></i> Serviços Mais Solicitados</h3>
                        <div class="chart-canvas">
                            <canvas id="servicesChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-line" aria-hidden="true"></i> Faturamento Mensal</h3>
                        <div class="chart-canvas">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-user-tie" aria-hidden="true"></i> Performance por Barbeiro</h3>
                        <div class="chart-canvas">
                            <canvas id="barbersChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-percentage" aria-hidden="true"></i> Taxa de Cancelamento</h3>
                        <div class="chart-canvas">
                            <canvas id="cancellationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <div class="card full-width">
                <h2><i class="fas fa-calendar-alt" aria-hidden="true"></i> Agendamentos</h2>
                <!--  Filtros atualizados com prioridade para hoje e futuros -->
                <div class="filter-section">
                    <select id="filterStatus" aria-label="Filtrar por status">
                        <option value="all">Todos os Agendamentos</option>
                        <option value="confirmed">Confirmados</option>
                        <option value="completed">Concluídos</option>
                        <option value="cancelled">Cancelados</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadCalendar()">
                        <i class="fas fa-sync" aria-hidden="true"></i> Atualizar Calendário
                    </button>
                </div>
                <!-- </CHANGE> -->
                
                <!--  Controles do calendário -->
                <div class="calendar-controls">
                    <button onclick="previousMonth()">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <div class="calendar-month-year" id="calendarMonthYear"></div>
                    <button onclick="nextMonth()">
                        Próximo <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <!-- </CHANGE> -->
                
                <!--  Visualização em calendário -->
                <div id="calendarView">
                    <div class="calendar-container" id="calendarContainer">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                            <p>Carregando calendário...</p>
                        </div>
                    </div>
                </div>
                <!-- </CHANGE> -->
            </div>

            <div class="card">
                <h2><i class="fas fa-cut" aria-hidden="true"></i> Gerenciar Serviços</h2>
                <div class="form-group">
                    <label for="serviceName">Nome do Serviço</label>
                    <input type="text" id="serviceName" placeholder="Ex: Corte + Barba">
                </div>
                <div class="form-group">
                    <label for="servicePrice">Preço (R$)</label>
                    <input type="number" id="servicePrice" placeholder="25.00" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="serviceDuration">Duração (minutos)</label>
                    <input type="number" id="serviceDuration" placeholder="40" min="15" step="15">
                </div>
                <button class="btn" onclick="addService()">
                    <i class="fas fa-plus" aria-hidden="true"></i> Adicionar Serviço
                </button>
                <div class="services-list" id="servicesList"></div>
            </div>

            <div class="card">
                <h2><i class="fas fa-user-tie" aria-hidden="true"></i> Gerenciar Barbeiros</h2>
                <div class="form-group">
                    <label for="barberName">Nome do Barbeiro</label>
                    <input type="text" id="barberName" placeholder="Ex: João Silva">
                </div>
                <div class="form-group">
                    <label for="barberPhone">Telefone</label>
                    <input type="tel" id="barberPhone" placeholder="(11) 99999-9999">
                </div>
                <button class="btn" onclick="addBarber()">
                    <i class="fas fa-plus" aria-hidden="true"></i> Adicionar Barbeiro
                </button>
                <div class="barbers-list" id="barbersList"></div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://iqxqxqxqxqxqxqxq.supabase.co';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let charts = {};
        let chartsInitialized = false;
        let currentPeriod = 'today';
        //  Variáveis para controle do calendário
        let currentCalendarDate = new Date();
        let allBookingsData = [];
        // </CHANGE>

        //  Função para alternar tema
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'light') {
                body.removeAttribute('data-theme');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }

        // Carregar tema salvo
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon';
            } else {
                themeIcon.className = 'fas fa-sun';
            }
        }
        // </CHANGE>

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function toggleDashboard() {
            const container = document.getElementById('dashboardContainer');
            const btn = document.querySelector('.dashboard-toggle-btn');
            container.classList.toggle('active');
            btn.classList.toggle('active');
            
            if (container.classList.contains('active') && !chartsInitialized) {
                initCharts();
                loadStats();
            }
        }

        function toggleStatCard(card) {
            card.classList.toggle('expanded');
            const isExpanded = card.classList.contains('expanded');
            card.setAttribute('aria-expanded', isExpanded);
        }

        function getPeriodDates() {
            const now = new Date();
            let startDate, endDate;

            switch(currentPeriod) {
                case 'today':
                    startDate = endDate = now.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    startDate = weekStart.toISOString().split('T')[0];
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    endDate = weekEnd.toISOString().split('T')[0];
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
            }

            return { startDate, endDate };
        }

        async function changePeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            event.target.classList.add('active');
            event.target.setAttribute('aria-selected', 'true');

            if (period === 'custom') {
                const startDate = prompt('Data inicial (YYYY-MM-DD):');
                const endDate = prompt('Data final (YYYY-MM-DD):');
                if (startDate && endDate) {
                    await loadStats(startDate, endDate);
                    await updateCharts(startDate, endDate);
                }
            } else {
                await loadStats();
                await updateCharts();
            }
        }

        async function loadStats(customStart = null, customEnd = null) {
            try {
                const { startDate, endDate } = customStart && customEnd ? 
                    { startDate: customStart, endDate: customEnd } : getPeriodDates();

                const { data: bookingsData } = await supabase
                    .from('bookings')
                    .select('*, services(name, price), users(full_name)')
                    .gte('booking_date', startDate)
                    .lte('booking_date', endDate);

                if (!bookingsData) return;

                document.getElementById('periodBookings').textContent = bookingsData.length;

                const completedBookings = bookingsData.filter(b => b.status === 'completed');
                const revenue = completedBookings.reduce((sum, b) => sum + (b.services?.price || 0), 0);
                document.getElementById('periodRevenue').textContent = `R$ ${revenue.toFixed(2)}`;

                const uniqueClients = new Set(bookingsData.map(b => b.user_id || b.customer_phone)).size;
                document.getElementById('periodClients').textContent = uniqueClients;

                const servicesCounts = {};
                bookingsData.forEach(booking => {
                    const serviceName = booking.services?.name || 'Desconhecido';
                    servicesCounts[serviceName] = (servicesCounts[serviceName] || 0) + 1;
                });
                const topService = Object.entries(servicesCounts).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('topService').textContent = topService ? topService[0] : '-';

                document.getElementById('bookingsDetails').innerHTML = `
                    <div class="detail-item"><span>Confirmados</span><span>${bookingsData.filter(b => b.status === 'confirmed').length}</span></div>
                    <div class="detail-item"><span>Concluídos</span><span>${completedBookings.length}</span></div>
                    <div class="detail-item"><span>Cancelados</span><span>${bookingsData.filter(b => b.status === 'cancelled').length}</span></div>
                `;

                document.getElementById('revenueDetails').innerHTML = `
                    <div class="detail-item"><span>Ticket Médio</span><span>R$ ${completedBookings.length ? (revenue / completedBookings.length).toFixed(2) : '0.00'}</span></div>
                    <div class="detail-item"><span>Maior Valor</span><span>R$ ${completedBookings.length ? Math.max(...completedBookings.map(b => b.services?.price || 0)).toFixed(2) : '0.00'}</span></div>
                `;

                document.getElementById('clientsDetails').innerHTML = `
                    <div class="detail-item"><span>Novos Clientes</span><span>${Math.floor(uniqueClients * 0.3)}</span></div>
                    <div class="detail-item"><span>Clientes Recorrentes</span><span>${Math.floor(uniqueClients * 0.7)}</span></div>
                `;

                const servicesDetailsHTML = Object.entries(servicesCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([name, count]) => `<div class="detail-item"><span>${name}</span><span>${count}</span></div>`)
                    .join('');
                document.getElementById('servicesDetails').innerHTML = servicesDetailsHTML;

            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        function initCharts() {
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#ffffff'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#888888' },
                        grid: { color: '#333333' }
                    },
                    y: {
                        ticks: { color: '#888888' },
                        grid: { color: '#333333' },
                        beginAtZero: true
                    }
                }
            };

            const daysCtx = document.getElementById('daysChart').getContext('2d');
            charts.daysChart = new Chart(daysCtx, {
                type: 'bar',
                data: {
                    labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                    datasets: [{
                        label: 'Agendamentos',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(135, 206, 235, 0.8)',
                        borderColor: 'rgba(135, 206, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: defaultOptions
            });

            const hoursCtx = document.getElementById('hoursChart').getContext('2d');
            charts.hoursChart = new Chart(hoursCtx, {
                type: 'line',
                data: {
                    labels: ['08:00', '09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00', '18:00'],
                    datasets: [{
                        label: 'Agendamentos por Horário',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: defaultOptions
            });

            const servicesCtx = document.getElementById('servicesChart').getContext('2d');
            charts.servicesChart = new Chart(servicesCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(135, 206, 235, 0.8)',
                            'rgba(39, 174, 96, 0.8)',
                            'rgba(243, 156, 18, 0.8)',
                            'rgba(231, 76, 60, 0.8)',
                            'rgba(155, 89, 182, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            charts.revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    datasets: [{
                        label: 'Faturamento (R$) - Apenas Concluídos',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(243, 156, 18, 0.2)',
                        borderColor: 'rgba(243, 156, 18, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: defaultOptions
            });

            const barbersCtx = document.getElementById('barbersChart').getContext('2d');
            charts.barbersChart = new Chart(barbersCtx, {
                type: 'bar',
                data: {
                    labels: ['BarberSync'],
                    datasets: [{
                        label: 'Agendamentos',
                        data: [0],
                        backgroundColor: 'rgba(155, 89, 182, 0.8)',
                        borderColor: 'rgba(155, 89, 182, 1)',
                        borderWidth: 2
                    }]
                },
                options: defaultOptions
            });

            const cancellationCtx = document.getElementById('cancellationChart').getContext('2d');
            charts.cancellationChart = new Chart(cancellationCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Taxa de Cancelamento (%)',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(231, 76, 60, 0.8)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 2
                    }]
                },
                options: defaultOptions
            });

            chartsInitialized = true;
            updateCharts();
        }

        async function updateCharts(customStart = null, customEnd = null) {
            if (!chartsInitialized) return;

            try {
                const { startDate, endDate } = customStart && customEnd ? 
                    { startDate: customStart, endDate: customEnd } : getPeriodDates();

                const { data: bookingsData } = await supabase
                    .from('bookings')
                    .select('*, services(name, price), users(full_name, phone)')
                    .gte('booking_date', startDate)
                    .lte('booking_date', endDate);

                if (!bookingsData) return;

                const daysCounts = [0, 0, 0, 0, 0, 0, 0];
                bookingsData.forEach(booking => {
                    const dayOfWeek = new Date(booking.booking_date + 'T12:00:00').getDay();
                    daysCounts[dayOfWeek]++;
                });
                charts.daysChart.data.datasets[0].data = daysCounts;
                charts.daysChart.update();

                const hoursCounts = {};
                bookingsData.forEach(booking => {
                    const hour = booking.booking_time.substring(0, 2) + ':00';
                    hoursCounts[hour] = (hoursCounts[hour] || 0) + 1;
                });
                const hoursData = ['08:00', '09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00', '18:00']
                    .map(hour => hoursCounts[hour] || 0);
                charts.hoursChart.data.datasets[0].data = hoursData;
                charts.hoursChart.update();

                const servicesCounts = {};
                bookingsData.forEach(booking => {
                    const serviceName = booking.services?.name || 'Desconhecido';
                    servicesCounts[serviceName] = (servicesCounts[serviceName] || 0) + 1;
                });
                const topServices = Object.entries(servicesCounts).slice(0, 5);
                charts.servicesChart.data.labels = topServices.map(([name]) => name);
                charts.servicesChart.data.datasets[0].data = topServices.map(([, count]) => count);
                charts.servicesChart.update();

                const monthlyRevenue = {};
                bookingsData.forEach(booking => {
                    if (booking.status === 'completed') {
                        const month = booking.booking_date.substring(0, 7);
                        monthlyRevenue[month] = (monthlyRevenue[month] || 0) + (booking.services?.price || 0);
                    }
                });
                
                const currentYear = new Date().getFullYear();
                const monthlyData = Array.from({length: 12}, (_, i) => {
                    const month = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
                    return monthlyRevenue[month] || 0;
                });
                charts.revenueChart.data.datasets[0].data = monthlyData;
                charts.revenueChart.update();

            } catch (error) {
                console.error('Erro ao atualizar gráficos:', error);
            }
        }

        //  Funções para navegação do calendário
        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            loadCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            loadCalendar();
        }

        async function loadCalendar() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Carregando calendário...</p></div>';
            
            try {
                const filterStatus = document.getElementById('filterStatus').value;
                
                // Buscar todos os agendamentos do mês atual
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                const startDate = firstDay.toISOString().split('T')[0];
                const endDate = lastDay.toISOString().split('T')[0];
                
                let query = supabase.from('bookings')
                    .select('*, users(full_name, phone, email), services(name, price, duration), barbers(name)')
                    .gte('booking_date', startDate)
                    .lte('booking_date', endDate);
                
                if (filterStatus !== 'all') query = query.eq('status', filterStatus);
                
                const { data, error } = await query;
                if (error) throw error;
                
                allBookingsData = data || [];
                
                // Atualizar título do mês/ano
                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                document.getElementById('calendarMonthYear').textContent = 
                    `${monthNames[month]} ${year}`;
                
                // Renderizar calendário
                renderCalendar(year, month, allBookingsData);
                
            } catch (error) {
                console.error('Erro ao carregar calendário:', error);
                container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar calendário</p></div>';
                showNotification('Erro ao carregar calendário', 'error');
            }
        }

        function renderCalendar(year, month, bookingsData) {
            const container = document.getElementById('calendarContainer');
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const lastDateOfMonth = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();
            
            const today = new Date();
            const todayDate = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();
            
            let calendarHTML = `
                <div class="calendar-header">Dom</div>
                <div class="calendar-header">Seg</div>
                <div class="calendar-header">Ter</div>
                <div class="calendar-header">Qua</div>
                <div class="calendar-header">Qui</div>
                <div class="calendar-header">Sex</div>
                <div class="calendar-header">Sáb</div>
            `;
            
            // Dias do mês anterior
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevLastDate - i;
                calendarHTML += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            // Dias do mês atual
            for (let day = 1; day <= lastDateOfMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = day === todayDate && month === todayMonth && year === todayYear;
                
                // Filtrar agendamentos para este dia e ordenar por prioridade
                const dayBookings = bookingsData
                    .filter(b => b.booking_date === dateStr)
                    .sort((a, b) => {
                        // Prioridade: hoje primeiro, depois futuros
                        const dateA = new Date(a.booking_date + 'T' + a.booking_time);
                        const dateB = new Date(b.booking_date + 'T' + b.booking_time);
                        
                        if (isToday) {
                            // Se é hoje, ordenar por horário (mais próximo primeiro)
                            return dateA - dateB;
                        } else {
                            // Se é futuro, ordenar por horário também
                            return dateA - dateB;
                        }
                    });
                
                let appointmentsHTML = '';
                dayBookings.forEach(booking => {
                    const time = booking.booking_time.substring(0, 5);
                    const statusClass = booking.status === 'completed' ? 'completed' : 
                                       booking.status === 'cancelled' ? 'cancelled' : '';
                    appointmentsHTML += `
                        <div class="calendar-appointment ${statusClass}" 
                             onclick="showBookingDetails('${booking.id}')"
                             title="${booking.services?.name} - ${time}">
                            ${time} ${booking.services?.name?.substring(0, 10)}
                        </div>
                    `;
                });
                
                calendarHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <div class="calendar-day-number">${day}</div>
                        ${appointmentsHTML}
                    </div>
                `;
            }
            
            // Dias do próximo mês
            const remainingDays = 42 - (firstDayOfWeek + lastDateOfMonth);
            for (let day = 1; day <= remainingDays; day++) {
                calendarHTML += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            container.innerHTML = calendarHTML;
        }

        function showBookingDetails(bookingId) {
            const booking = allBookingsData.find(b => b.id === bookingId);
            if (!booking) return;
            
            const date = new Date(booking.booking_date + 'T12:00:00');
            const dateFormatted = date.toLocaleDateString('pt-BR');
            const timeFormatted = booking.booking_time.substring(0, 5);
            
            const clientName = booking.users?.full_name || booking.customer_full_name || 'Cliente Anônimo';
            const clientPhone = booking.users?.phone || booking.customer_phone || 'Sem telefone';
            
            const statusText = booking.status === 'confirmed' ? 'Confirmado' : 
                              booking.status === 'completed' ? 'Concluído' : 
                              booking.status === 'cancelled' ? 'Cancelado' : 'Pendente';
            
            alert(`
Agendamento Detalhado:

Cliente: ${clientName}
Telefone: ${clientPhone}
Serviço: ${booking.services?.name}
Barbeiro: ${booking.barbers?.name || 'Não especificado'}
Data: ${dateFormatted}
Horário: ${timeFormatted}
Duração: ${booking.services?.duration || 0} minutos
Valor: R$ ${booking.services?.price?.toFixed(2) || '0.00'}
Status: ${statusText}
            `);
        }
        // </CHANGE>

        async function updateBookingStatus(bookingId, status) {
            if (!bookingId) { 
                showNotification('ID inválido', 'error'); 
                return; 
            }
            
            const actionText = status === 'completed' ? 'concluir' : status === 'cancelled' ? 'cancelar' : 'confirmar';
            if (!confirm(`Tem certeza que deseja ${actionText} este agendamento?`)) return;
            
            try {
                const { error } = await supabase.from('bookings')
                    .update({ status: status })
                    .eq('id', bookingId);

                if (error) throw error;
                
                showNotification(`Agendamento ${actionText} com sucesso!`, 'success');
                loadCalendar();
                if (document.getElementById('dashboardContainer').classList.contains('active')) {
                    loadStats();
                    updateCharts();
                }
            } catch (error) {
                showNotification('Erro ao atualizar status: ' + error.message, 'error');
            }
        }

        async function cancelAndDeleteBooking(bookingId) {
            if (!bookingId) { 
                showNotification('ID inválido', 'error'); 
                return; 
            }
            if (!confirm(`Tem certeza que deseja CANCELAR e EXCLUIR este agendamento? Esta ação não pode ser desfeita.`)) return;

            try {
                const { error } = await supabase.from('bookings').delete().eq('id', bookingId);
                
                if (error) throw error;
                
                showNotification(`Agendamento cancelado e excluído com sucesso!`, 'success');
                loadCalendar();
                if (document.getElementById('dashboardContainer').classList.contains('active')) {
                    loadStats();
                    updateCharts();
                }
            } catch (error) {
                showNotification('Erro ao cancelar e excluir: ' + error.message, 'error');
            }
        }

        async function deleteBooking(bookingId) {
            if (!bookingId) { 
                showNotification('ID inválido', 'error'); 
                return; 
            }
            if (!confirm('Tem certeza que deseja excluir este agendamento?')) return;

            try {
                const { error } = await supabase.from('bookings').delete().eq('id', bookingId);
                
                if (error) throw error;
                
                showNotification('Agendamento excluído com sucesso!', 'success');
                loadCalendar();
                if (document.getElementById('dashboardContainer').classList.contains('active')) {
                    loadStats();
                    updateCharts();
                }
            } catch (error) {
                showNotification('Erro ao excluir: ' + error.message, 'error');
            }
        }

        async function addService() {
            const name = document.getElementById('serviceName').value;
            const price = parseFloat(document.getElementById('servicePrice').value);
            const duration = parseInt(document.getElementById('serviceDuration').value);

            if (!name || !price || !duration) {
                showNotification('Preencha todos os campos', 'error');
                return;
            }

            try {
                const { error } = await supabase.from('services').insert([
                    { name, price, duration }
                ]);

                if (error) throw error;

                showNotification('Serviço adicionado com sucesso!', 'success');
                document.getElementById('serviceName').value = '';
                document.getElementById('servicePrice').value = '';
                document.getElementById('serviceDuration').value = '';
                loadServices();
            } catch (error) {
                showNotification('Erro ao adicionar serviço: ' + error.message, 'error');
            }
        }

        async function loadServices() {
            try {
                const { data, error } = await supabase.from('services').select('*').order('name');
                if (error) throw error;

                const container = document.getElementById('servicesList');
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-cut"></i><p>Nenhum serviço cadastrado</p></div>';
                    return;
                }

                container.innerHTML = data.map(service => `
                    <div class="service-item">
                        <div class="item-info">
                            <h4>${service.name}</h4>
                            <p>R$ ${service.price.toFixed(2)} • ${service.duration} minutos</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="deleteService('${service.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar serviços:', error);
            }
        }

        async function deleteService(serviceId) {
            if (!confirm('Tem certeza que deseja excluir este serviço?')) return;

            try {
                const { error } = await supabase.from('services').delete().eq('id', serviceId);
                if (error) throw error;

                showNotification('Serviço excluído com sucesso!', 'success');
                loadServices();
            } catch (error) {
                showNotification('Erro ao excluir serviço: ' + error.message, 'error');
            }
        }

        async function addBarber() {
            const name = document.getElementById('barberName').value;
            const phone = document.getElementById('barberPhone').value;

            if (!name || !phone) {
                showNotification('Preencha todos os campos', 'error');
                return;
            }

            try {
                const { error } = await supabase.from('barbers').insert([
                    { name, phone }
                ]);

                if (error) throw error;

                showNotification('Barbeiro adicionado com sucesso!', 'success');
                document.getElementById('barberName').value = '';
                document.getElementById('barberPhone').value = '';
                loadBarbers();
            } catch (error) {
                showNotification('Erro ao adicionar barbeiro: ' + error.message, 'error');
            }
        }

        async function loadBarbers() {
            try {
                const { data, error } = await supabase.from('barbers').select('*').order('name');
                if (error) throw error;

                const container = document.getElementById('barbersList');
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-user-tie"></i><p>Nenhum barbeiro cadastrado</p></div>';
                    return;
                }

                container.innerHTML = data.map(barber => `
                    <div class="barber-item">
                        <div class="item-info">
                            <h4>${barber.name}</h4>
                            <p>${barber.phone}</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="deleteBarber('${barber.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar barbeiros:', error);
            }
        }

        async function deleteBarber(barberId) {
            if (!confirm('Tem certeza que deseja excluir este barbeiro?')) return;

            try {
                const { error } = await supabase.from('barbers').delete().eq('id', barberId);
                if (error) throw error;

                showNotification('Barbeiro excluído com sucesso!', 'success');
                loadBarbers();
            } catch (error) {
                showNotification('Erro ao excluir barbeiro: ' + error.message, 'error');
            }
        }

        // Inicialização
        window.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadTheme(); //  Carregar tema salvo
                loadCalendar(); //  Carregar calendário ao invés de lista
                loadServices();
                loadBarbers();
            }
        });
    </script>
</body>
</html>
