<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Lembretes - BarberSync</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 4px solid #87ceeb;
        }
        .header h1 {
            color: #87ceeb;
            margin-bottom: 10px;
        }
        .status-card {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }
        .status-card.warning {
            border-left-color: #ff9800;
        }
        .status-card.error {
            border-left-color: #ff4444;
        }
        .control-panel {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 25px;
            background: #87ceeb;
            color: #0a0a0a;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #4682b4;
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: transparent;
            border: 2px solid #87ceeb;
            color: #87ceeb;
        }
        .btn-secondary:hover {
            background: rgba(135, 206, 235, 0.1);
        }
        .log-container {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #87ceeb;
            background: #0a0a0a;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
        .log-entry.success {
            border-left-color: #4caf50;
        }
        .log-entry.error {
            border-left-color: #ff4444;
        }
        .log-entry.warning {
            border-left-color: #ff9800;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border-left: 4px solid #87ceeb;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #87ceeb;
            margin: 10px 0;
        }
        .stat-label {
            color: #888888;
            font-size: 14px;
        }
        .config-section {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #888888;
            font-size: 14px;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #87ceeb;
        }
        .timestamp {
            color: #888888;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîî Sistema de Lembretes Autom√°ticos</h1>
            <p style="color: #888888; margin-top: 10px;">
                Envia lembretes autom√°ticos para clientes com agendamentos nas pr√≥ximas horas
            </p>
        </div>

        <div class="config-section">
            <h2 style="color: #87ceeb; margin-bottom: 20px;">‚öôÔ∏è Configura√ß√µes</h2>
            <div class="form-group">
                <label for="webhookUrl">URL do Webhook N8N</label>
                <input 
                    type="url" 
                    id="webhookUrl" 
                    value="https://n8n-n8n.rthuab.easypanel.host/webhook/lembrete"
                    placeholder="https://seu-n8n.com/webhook/lembretes">
            </div>
            <div class="form-group">
                <label for="reminderTime">Tempo de Anteced√™ncia (minutos)</label>
                <input 
                    type="number" 
                    id="reminderTime" 
                    value="60"
                    min="15"
                    max="1440">
                <small style="color: #888888; font-size: 12px; display: block; margin-top: 5px;">
                    Padr√£o: 60 minutos (1 hora)
                </small>
            </div>
            <div class="form-group">
                <label for="checkInterval">Intervalo de Verifica√ß√£o (minutos)</label>
                <input 
                    type="number" 
                    id="checkInterval" 
                    value="15"
                    min="5"
                    max="60">
                <small style="color: #888888; font-size: 12px; display: block; margin-top: 5px;">
                    Com que frequ√™ncia verificar novos agendamentos
                </small>
            </div>
            <button class="btn" onclick="saveConfig()">üíæ Salvar Configura√ß√µes</button>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Lembretes Enviados Hoje</div>
                <div class="stat-value" id="totalSent">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Agendamentos Pr√≥ximos</div>
                <div class="stat-value" id="upcomingCount">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">√öltima Verifica√ß√£o</div>
                <div class="stat-value" id="lastCheck" style="font-size: 18px;">--:--</div>
            </div>
        </div>

        <div class="status-card" id="statusCard">
            <h3 style="color: #4caf50; margin-bottom: 10px;">‚è∏Ô∏è Sistema Parado</h3>
            <p id="statusText">Clique em "Iniciar Sistema" para come√ßar a verifica√ß√£o autom√°tica</p>
        </div>

        <div class="control-panel">
            <h2 style="color: #87ceeb; margin-bottom: 20px;">üéÆ Controles</h2>
            <button class="btn" onclick="startSystem()" id="startBtn">
                ‚ñ∂Ô∏è Iniciar Sistema
            </button>
            <button class="btn btn-secondary" onclick="stopSystem()" id="stopBtn" disabled>
                ‚èπÔ∏è Parar Sistema
            </button>
            <button class="btn btn-secondary" onclick="checkNow()">
                üîç Verificar Agora
            </button>
            <button class="btn btn-secondary" onclick="clearLogs()">
                üóëÔ∏è Limpar Logs
            </button>
        </div>

        <div class="log-container">
            <h2 style="color: #87ceeb; margin-bottom: 20px;">üìã Logs do Sistema</h2>
            <div id="logEntries">
                <div class="log-entry">
                    <span class="timestamp">[Sistema]</span> Aguardando in√≠cio...
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://syrlmjrbecidbpvofiqa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cmxtanJiZWNpZGJwdm9maXFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMzE0NDQsImV4cCI6MjA3NTgwNzQ0NH0.80whwN7m1YbwuZ8WLzek-ctWd9KNn97EwUQRzOMAnak';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let systemRunning = false;
        let checkIntervalId = null;
        let sentRemindersToday = new Set();
        let config = {
            webhookUrl: 'https://n8n-n8n.rthuab.easypanel.host/webhook/lembrete',
            reminderTime: 60, // minutos
            checkInterval: 15 // minutos
        };

        // Carregar configura√ß√µes salvas
        function loadConfig() {
            const savedConfig = localStorage.getItem('reminderConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                document.getElementById('webhookUrl').value = config.webhookUrl;
                document.getElementById('reminderTime').value = config.reminderTime;
                document.getElementById('checkInterval').value = config.checkInterval;
            }

            const savedReminders = localStorage.getItem('sentRemindersToday');
            if (savedReminders) {
                const data = JSON.parse(savedReminders);
                const today = new Date().toDateString();
                if (data.date === today) {
                    sentRemindersToday = new Set(data.reminders);
                } else {
                    localStorage.removeItem('sentRemindersToday');
                }
            }
            updateStats();
        }

        function saveConfig() {
            config.webhookUrl = document.getElementById('webhookUrl').value;
            config.reminderTime = parseInt(document.getElementById('reminderTime').value);
            config.checkInterval = parseInt(document.getElementById('checkInterval').value);
            
            localStorage.setItem('reminderConfig', JSON.stringify(config));
            addLog('‚öôÔ∏è Configura√ß√µes salvas com sucesso!', 'success');

            if (systemRunning) {
                stopSystem();
                setTimeout(() => startSystem(), 1000);
                addLog('üîÑ Sistema reiniciado com novas configura√ß√µes', 'warning');
            }
        }

        function startSystem() {
            if (systemRunning) return;
            
            systemRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            updateStatus('running');
            addLog('‚úÖ Sistema iniciado', 'success');
            
            // Primeira verifica√ß√£o imediata
            checkForReminders();
            
            // Configurar verifica√ß√µes peri√≥dicas
            checkIntervalId = setInterval(() => {
                checkForReminders();
            }, config.checkInterval * 60 * 1000);
        }

        function stopSystem() {
            if (!systemRunning) return;
            
            systemRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (checkIntervalId) {
                clearInterval(checkIntervalId);
                checkIntervalId = null;
            }
            
            updateStatus('stopped');
            addLog('‚èπÔ∏è Sistema parado', 'warning');
        }

        function checkNow() {
            addLog('üîç Verifica√ß√£o manual iniciada...', 'warning');
            checkForReminders();
        }

        async function checkForReminders() {
            try {
                const now = new Date();
                const checkTime = new Date(now.getTime() + config.reminderTime * 60000);
                
                // Formatar datas para busca
                const today = now.toISOString().split('T')[0];
                const checkTimeStr = checkTime.toTimeString().split(' ')[0].substring(0, 5);
                
                addLog(`üîé Verificando agendamentos para ${checkTimeStr}...`);
                
                // Buscar agendamentos confirmados
                const { data: bookings, error } = await supabase
                    .from('bookings')
                    .select('*, users(full_name, phone, email), services(name, price, duration), barbers(name)')
                    .eq('booking_date', today)
                    .eq('status', 'confirmed')
                    .order('booking_time', { ascending: true });

                if (error) throw error;

                if (!bookings || bookings.length === 0) {
                    addLog('‚ÑπÔ∏è Nenhum agendamento confirmado para hoje');
                    updateLastCheck();
                    updateStats();
                    return;
                }

                // Filtrar agendamentos que precisam de lembrete
                const bookingsToRemind = bookings.filter(booking => {
                    const bookingTime = new Date(`${booking.booking_date}T${booking.booking_time}`);
                    const timeDiff = (bookingTime - now) / 60000; // diferen√ßa em minutos
                    
                    // Verificar se est√° no intervalo de tempo para lembrete
                    const inTimeWindow = timeDiff <= config.reminderTime && timeDiff > (config.reminderTime - config.checkInterval);
                    
                    // Verificar se j√° foi enviado lembrete
                    const alreadySent = sentRemindersToday.has(booking.id);
                    
                    return inTimeWindow && !alreadySent;
                });

                addLog(`üìä ${bookingsToRemind.length} lembrete(s) para enviar`);

                // Enviar lembretes
                for (const booking of bookingsToRemind) {
                    await sendReminder(booking);
                }

                updateLastCheck();
                updateStats();

            } catch (error) {
                addLog(`‚ùå Erro ao verificar agendamentos: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function sendReminder(booking) {
            try {
                const dateFormatted = new Date(booking.booking_date + 'T12:00:00')
                    .toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        day: 'numeric', 
                        month: 'long' 
                    });
                
                const timeFormatted = booking.booking_time.substring(0, 5);

                const reminderData = {
                    type: 'reminder',
                    booking_id: booking.id,
                    customer_name: booking.users?.full_name || 'Cliente',
                    customer_email: booking.users?.email || '',
                    customer_phone: booking.users?.phone || '',
                    service_name: booking.services?.name || 'Servi√ßo',
                    service_price: booking.services?.price || 0,
                    service_duration: booking.services?.duration || 0,
                    barber_name: booking.barbers?.name || 'Barbeiro',
                    booking_date: dateFormatted,
                    booking_time: timeFormatted,
                    booking_datetime: `${booking.booking_date}T${booking.booking_time}`,
                    minutes_before: config.reminderTime,
                    status: 'confirmed'
                };

                const response = await fetch(config.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reminderData)
                });

                if (!response.ok) {
                    throw new Error(`Webhook retornou status ${response.status}`);
                }

                // Marcar como enviado
                sentRemindersToday.add(booking.id);
                saveSentReminders();

                addLog(
                    `‚úÖ Lembrete enviado: ${booking.users?.full_name} - ${timeFormatted}`, 
                    'success'
                );

            } catch (error) {
                addLog(
                    `‚ùå Erro ao enviar lembrete para ${booking.users?.full_name}: ${error.message}`, 
                    'error'
                );
                console.error('Erro ao enviar lembrete:', error);
            }
        }

        function saveSentReminders() {
            const data = {
                date: new Date().toDateString(),
                reminders: Array.from(sentRemindersToday)
            };
            localStorage.setItem('sentRemindersToday', JSON.stringify(data));
        }

        function updateStatus(status) {
            const statusCard = document.getElementById('statusCard');
            const statusText = document.getElementById('statusText');
            
            if (status === 'running') {
                statusCard.className = 'status-card';
                statusCard.innerHTML = `
                    <h3 style="color: #4caf50; margin-bottom: 10px;">‚úÖ Sistema Ativo</h3>
                    <p id="statusText">Verificando agendamentos a cada ${config.checkInterval} minutos</p>
                `;
            } else {
                statusCard.className = 'status-card warning';
                statusCard.innerHTML = `
                    <h3 style="color: #ff9800; margin-bottom: 10px;">‚è∏Ô∏è Sistema Parado</h3>
                    <p id="statusText">Clique em "Iniciar Sistema" para come√ßar a verifica√ß√£o autom√°tica</p>
                `;
            }
        }

        function updateLastCheck() {
            const now = new Date();
            document.getElementById('lastCheck').textContent = 
                now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        async function updateStats() {
            document.getElementById('totalSent').textContent = sentRemindersToday.size;
            
            try {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                
                const { data: upcomingBookings } = await supabase
                    .from('bookings')
                    .select('id')
                    .eq('booking_date', today)
                    .eq('status', 'confirmed');
                
                document.getElementById('upcomingCount').textContent = 
                    upcomingBookings?.length || 0;
            } catch (error) {
                console.error('Erro ao atualizar estat√≠sticas:', error);
            }
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logEntries');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Manter apenas √∫ltimas 100 entradas
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function clearLogs() {
            const logContainer = document.getElementById('logEntries');
            logContainer.innerHTML = '<div class="log-entry"><span class="timestamp">[Sistema]</span> Logs limpos</div>';
        }

        // Inicializar ao carregar p√°gina
        window.addEventListener('load', () => {
            loadConfig();
            addLog('üí° Sistema carregado e pronto para uso');
            addLog(`‚öôÔ∏è Configurado para enviar lembretes ${config.reminderTime} minutos antes`);
            
            // Verificar se deve iniciar automaticamente
            const autoStart = localStorage.getItem('autoStartReminders');
            if (autoStart === 'true') {
                setTimeout(() => startSystem(), 2000);
            }
        });

        // Resetar lembretes enviados √† meia-noite
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) {
                sentRemindersToday.clear();
                localStorage.removeItem('sentRemindersToday');
                addLog('üîÑ Contador de lembretes resetado para novo dia', 'warning');
                updateStats();
            }
        }, 60000); // Verificar a cada minuto

        // Salvar estado antes de sair
        window.addEventListener('beforeunload', () => {
            if (systemRunning) {
                localStorage.setItem('autoStartReminders', 'true');
            } else {
                localStorage.removeItem('autoStartReminders');
            }
        });
    </script>
</body>
</html>